# Документация по скриптам Tampermonkey для шахматных сайтов

## Обзор системы

Система состоит из 10 модульных скриптов, каждый из которых отвечает за определённую функциональность. Скрипты взаимодействуют через общее хранилище GM (GreaseMonkey) и могут работать как независимо, так и совместно.

## Список скриптов

### 01_chessking_tracker.js - Основной трекер ChessKing
**Назначение**: Центральная система отслеживания прогресса решения задач на ChessKing с поддержкой режима обучения  
**Основные функции**:
- Отслеживание количества решённых задач в день
- Автоматический редирект на страницу задач при недостаточном прогрессе
- **Интеграция с режимом обучения** - временная приостановка требований задач во время обучения (9:00-10:00)
- Визуальный интерфейс с графиками прогресса и статистикой
- Расчёт средней и максимальной скорости решения
- Прогнозирование времени до завершения курса
- Обновление заголовка страницы с количеством оставшихся задач

**Домены**: `learn.chessking.com`  
**Настройки**:
- `courseId = 72` - ID курса ChessKing
- `minTasksPerDay = 2000` - **увеличенный** минимум задач в день для разблокировки

**GM ключи**:
- `initial_solved_${courseId}_${date}` - начальное количество решённых задач
- `daily_solved_${courseId}_${date}` - количество задач, решённых сегодня
- `cached_solved_${courseId}_${date}` - кэш: решено сегодня
- `cached_unlock_${courseId}_${date}` - кэш: осталось до разблокировки
- `training_completed_${date}` - **НОВОЕ**: проверка завершения обучения (чтение)

---

### 02_animation_autoclick.js - Анимации и автоклик ChessKing
**Назначение**: Ускорение интерфейса ChessKing для более быстрого решения задач  
**Основные функции**:
- Переопределение jQuery анимаций (мгновенное выполнение)
- Автоматический клик по кнопке "Следующее задание"
- Мониторинг изменений DOM для автоклика

**Домены**: `learn.chessking.com`  
**Технические детали**:
- Переопределяет `jQuery.animate`, `fadeIn`, `fadeOut`
- Использует `MutationObserver` для отслеживания появления кнопок
- Проверяет видимость элементов перед кликом

---

### 03_chesscom_filter.js - Фильтр контента Chess.com
**Назначение**: Очистка интерфейса Chess.com от нежелательного контента  
**Основные функции**:
- Фильтрация турниров по ключевым словам
- Скрытие элементов интерфейса через CSS
- Скрытие специфических турниров и секций через JavaScript

**Домены**: `chess.com`, `www.chess.com`  
**Фильтры турниров**: Bullet, Live 960, 3 Check, King of the Hill, Crazyhouse  
**Скрываемые элементы**:
- Варианты шахмат
- Неактивные вкладки турниров
- Боковые панели
- Элементы навигации
- Секции "Заочные", "Пуля", "Последние"

---

### 04_lichess_filter.js - Фильтр контента Lichess (только Блиц+Рапид)
**Назначение**: Ограничение доступа только к играм Блиц и Рапид на Lichess + фильтрация тем тренировок  
**Основные функции**:
- Показ только турниров Блиц и Рапид (CSS фильтр)
- Скрытие кнопок "Участвовать" для других типов игр
- Скрытие шахматной доски для неразрешённых типов игр
- **Фильтрация тем тренировок**: скрытие специфических тем на `/training/themes`
- **Блокировка URL тренировок**: редирект заблокированных тем на `/training`
- Автоматическое определение типа игры/турнира

**Домены**: `lichess.org`  
**Разрешённые типы**: Блиц, Рапид, Blitz, Rapid  
**Заблокированные темы тренировок**:
- Все типы матов (мат в 1-4 хода, специальные маты)
- Специальные ходы (рокировка, взятие на проходе, превращения)
- Одно/двух/трёхходовые задачи
- Ссылка "Ещё >" на открытые дебюты

**Логика работы**:
- Анализирует мета-информацию турнира/игры
- CSS скрытие неразрешённых элементов
- JavaScript редирект для заблокированных URL
- Обработка клика с предотвращением перехода
- Использует `MutationObserver` для динамического контента

---

### 05_message_control.js - Контроль сообщений по задачам
**Назначение**: Ограничение отправки сообщений на основе количества решённых задач  
**Основные функции**:
- Подсчёт доступных сообщений на основе решённых задач
- Блокировка форм отправки при превышении лимита
- Визуальные индикаторы оставшихся сообщений
- Автоматический инкремент счётчика отправленных сообщений
- **Автоматическое определение активного трекера** - не требует конфигурации

**Домены**: `lichess.org/inbox/*`, `lichess.org/forum/team-*`  
**Соотношение**: 50 задач = 1 сообщение  
**GM ключи**:
- `messages_sent_${courseId}_${date}` - количество отправленных сообщений
- Читает `daily_solved_${courseId}_${date}` из любого трекера (01 или 09)

**Поддерживаемые формы**:
- Личные сообщения Lichess (`.msg-app__convo__post`)
- Форумы команд (`form.form3.reply`)

---

### 06_url_blocker.js - Блокировщик URL и список доменов
**Назначение**: Контроль доступа к сайтам через белый список доменов  
**Основные функции**:
- Блокировка нежелательных сайтов (YouTube, магазины расширений)
- Белый список разрешённых доменов
- Опциональный турнирный режим (закомментирован)
- Замена содержимого заблокированных страниц

**Заблокированные домены**:
- youtube.com, music.youtube.com
- Магазины расширений браузеров
- yandex.ru/extensions

**Разрешённые домены**:
- learn.chessking.com
- allcantrip.ru
- start.bizon365.ru
- worldchess.com
- chess.com
- lichess.org

**Турнирный режим** (отключён по умолчанию):
Разрешает только конкретные URL:
- https://learn.chessking.com/learning/course/72
- https://www.chess.com/puzzles/battle
- https://www.chess.com/puzzles/rush

---

### 07_time_blocker.js - Блокировщик по времени
**Назначение**: Временные ограничения доступа к сайтам в заданные временные интервалы  
**Основные функции**:
- Блокировка в определённые часы (13:00-18:00, 21:00-24:00)
- Предупреждающие таймеры за 20 минут до блокировки
- Полная блокировка страницы с информационным сообщением

**Настройки времени**:
- Блокировка 1: 13:00-18:00
- Блокировка 2: 21:00-24:00
- Предупреждение: за 20 минут до блокировки

---

### 10_training_redirect.js - Автоматический редирект на обучение
**Назначение**: Автоматический редирект на страницу обучения в заданное время с контролем доменов  
**Основные функции**:
- Автоматический редирект в 9:00 на страницу урока
- Блокировка неразрешённых доменов во время обучения (9:00-10:00)
- Предупреждающие таймеры перед началом обучения
- Работает только в будние дни (Пн-Пт)

**Настройки обучения**:
- Время обучения: Пн-Пт 9:00-10:00
- Предупреждение: с 8:40 (за 20 минут)
- Разрешённый домен: `start.bizon365.ru`
- URL перенаправления: `https://allcantrip.ru/lesson`

**Логика работы**:
- 8:40-8:59: показ таймера до начала обучения
- 9:00: автоматический редирект на урок
- 9:01-9:59: блокировка всех сайтов кроме разрешённого домена
- Выходные: скрипт не активен

---

### 08_turnir.js - Турнир
**Назначение**: Строгий турнирный режим с блокировкой всех сайтов кроме указанных  
**Основные функции**:
- Разрешение только 3 конкретных URL
- Полная блокировка всех остальных сайтов
- Мгновенные анимации для ChessKing
- Автоклик "Следующее задание"

**Разрешённые URL**:
- https://learn.chessking.com/learning/course/72
- https://www.chess.com/puzzles/battle
- https://www.chess.com/puzzles/rush

---

### 09_lichess_tracker.js - Основной трекер Lichess Puzzles
**Назначение**: Альтернативная версия основного трекера для задач Lichess с поддержкой режима обучения и Lichess Racer  
**Основные функции**:
- Отслеживание количества решённых задач Lichess в день через API
- Автоматический редирект на страницу тренировок при недостаточном прогрессе
- **Поддержка Lichess Racer** - мониторинг гонок и автоматическое добавление правильно решённых задач к дневному счётчику
- **Интеграция с режимом обучения** - временная приостановка требований задач во время обучения (9:00-10:00)
- **Разрешённый доступ к тренировочным страницам**: `/training`, `/training/themes`, `/training/*`, `/racer`, `/racer/*`
- Визуальный интерфейс с графиками прогресса и статистикой (только на главной странице тренировок)
- Скрытие лёгких уровней сложности (Легчайший, Лёгкий)
- Скрытие кнопок "Взять подсказку" и "Посмотреть решение"
- Совместимость с системой контроля сообщений

**Домены**: Все сайты (перенаправляет на `lichess.org/training` только при недостаточном прогрессе)
**Настройки**:
- `lichessUsername = 'kazamba'` - имя пользователя Lichess
- `minTasksPerDay = 500` - **увеличенный** минимум задач в день для разблокировки

**Разрешённые URL при недостаточном прогрессе**:
- `https://lichess.org/training` - главная страница тренировок
- `https://lichess.org/training/themes` - выбор тем тренировок  
- `https://lichess.org/training/*` - любые конкретные темы (например, `queenRookEndgame`, `mateIn5`)
- `https://lichess.org/racer` - лобби гонок
- `https://lichess.org/racer/*` - конкретные гонки (например, `/racer/ABC123`)

**API**: `https://lichess.org/api/user/{username}/activity`
**GM ключи** (совместимы с 01_chessking_tracker.js):
- `daily_solved_${courseId}_${date}` - количество задач, решённых сегодня
- `cached_solved_${courseId}_${date}` - кэш: решено сегодня
- `cached_unlock_${courseId}_${date}` - кэш: осталось до разблокировки
- `training_completed_${date}` - **НОВОЕ**: проверка завершения обучения (чтение)

**Важно**: НЕ используйте одновременно с 01_chessking_tracker.js!

---

### 10_training_redirect.js - Автоматический редирект на обучение
**Назначение**: Автоматический редирект на страницу обучения в заданное время с контролем доменов  
**Основные функции**:
- Автоматический редирект в 9:00 на страницу урока
- Блокировка неразрешённых доменов во время обучения (9:00-10:00)
- Предупреждающие таймеры перед началом обучения
- Работает только в будние дни (Пн-Пт)

**Настройки обучения**:
- Время обучения: Пн-Пт 9:00-10:00
- Предупреждение: с 8:40 (за 20 минут)
- Разрешённый домен: `start.bizon365.ru`
- URL перенаправления: `https://allcantrip.ru/lesson`

**Логика работы**:
- 8:40-8:59: показ таймера до начала обучения
- 9:00: автоматический редирект на урок
- 9:01-9:59: блокировка всех сайтов кроме разрешённого домена
- Выходные: скрипт не активен

## Архитектура взаимодействия

### Обмен данными через GM Storage
Скрипты используют общие ключи для обмена данными:

**Основные ключи:**
```
daily_solved_${courseId}_${date}     // Основной трекер → Контроль сообщений
cached_unlock_${courseId}_${date}    // Основной трекер (кэш)
cached_solved_${courseId}_${date}    // Основной трекер (кэш)
messages_sent_${courseId}_${date}    // Контроль сообщений
```

**НОВОЕ: Ключи режима обучения:**
```
training_completed_${date}           // Скрипт #10 → Скрипты #01/#09 (отметка завершения)
```

### Схема зависимостей
```
01_chessking_tracker.js (центральные данные ChessKing)
    ↓ (предоставляет daily_solved_*)
05_message_control.js (использует данные о задачах)

09_lichess_tracker.js (центральные данные Lichess)
    ↓ (предоставляет daily_solved_* в том же формате)
05_message_control.js (совместим с любым трекером)

02_animation_autoclick.js ← независимый
03_chesscom_filter.js ← универсальный (любые платформы)  
04_lichess_filter.js ← универсальный (любые платформы)
05_message_control.js ← универсальный (любые трекеры)
06_url_blocker.js ← универсальный (любые платформы)
07_time_blocker.js ← универсальный (любые платформы)
08_turnir.js ← независимый (включает функции из 02)
10_training_redirect.js ← универсальный (любые платформы)
```

## Инструкции по установке

1. **Установите Tampermonkey** в браузер
2. **Импортируйте нужные скрипты** в Tampermonkey
3. **Настройте домены** в соответствии с вашими потребностями
4. **⚠️ ВАЖНО: Выберите ОДИН режим работы** (см. раздел "Режимы работы"):
   - **Турнирный режим**: только #08
   - **ChessKing режим**: #01-07, #10 (скрипты #03-07 универсальны)
   - **Lichess режим**: #03-07, #09-10 (скрипты #03-07 универсальны)

## Настройки и конфигурация

### Основной трекер (01)
- `courseId = 72` - измените на нужный курс
- `minTasksPerDay = 2000` - **увеличенный** минимум задач в день

### Контроль сообщений (05)  
- `tasksPerMessage = 50` - задач на одно сообщение

### Lichess трекер (09)
- `lichessUsername = 'kazamba'` - имя пользователя Lichess
- `minTasksPerDay = 500` - **увеличенный** минимум задач в день

### Тренинг-редирект (10)
- `enableTrainingMode = true/false` - **НОВОЕ**: полное отключение режима обучения
- `trainingStartHour/trainingEndHour` - время обучения
- `allowedTrainingDomain` - разрешённый домен обучения

### Блокировщик времени (07)
- `blockStart1/blockEnd1` - первый интервал блокировки
- `blockStart2/blockEnd2` - второй интервал блокировки
- `isTrainingEnabled` - включить/выключить обучение
- `trainingRedirectURL` - ссылка для обучения

### Турнир (08)
- Массив `allowed` - разрешённые URL в турнирном режиме

### Lichess трекер (09)
- `lichessUsername = 'kazamba'` - имя пользователя Lichess
- `minTasksPerDay = 10` - минимум задач в день

## ⚠️ ВАЖНО: Предотвращение конфликтов

### Критические конфликты при одновременном запуске:

**🚨 Высокий риск:**
- **07_time_blocker.js** + **08_turnir.js** - оба имеют @match *://*/* и могут блокировать одни и те же страницы
- **02_animation_autoclick.js** + **08_turnir.js** - дублируют переопределение jQuery и автоклик

**⚠️ Средний риск:**
- **04_lichess_filter.js** + **05_message_control.js** - оба работают на lichess.org (но в разных областях)

**✅ КОНФЛИКТЫ РАЗРЕШЕНЫ:**
- **07_time_blocker.js** + **10_training_redirect.js** - ⚠️ Ранее конфликт, но теперь **разрешён**: можно отключить #10 через `enableTrainingMode = false`

**✅ БЕЗ КОНФЛИКТОВ:**
- **06_url_blocker.js** безопасен с любыми другими - он блокирует только нежелательные сайты (YouTube, магазины расширений), НЕ затрагивает шахматные сайты
- **Режим обучения** (скрипты #01, #09, #10) - координируются через GM Storage, никаких конфликтов

### Режимы работы

**Универсальные скрипты** (#03-07): Работают с любыми платформами и могут использоваться во всех режимах:
- `03_chesscom_filter.js` - фильтр Chess.com
- `04_lichess_filter.js` - фильтр Lichess  
- `05_message_control.js` - контроль сообщений
- `06_url_blocker.js` - блокировщик URL
- `07_time_blocker.js` - блокировщик времени

**Режим 1: Турнирный** 🏆
```
Включить: только #08
Отключить: все остальные (#01-07, #09-10)
Описание: Максимально строгий режим, разрешены только 3 конкретных URL
Особенности: Включает встроенные анимации и автоклик для ChessKing
```

**Режим 2: ChessKing** ♔
```
Включить: #01-07, #10
Отключить: #08, #09
Описание: Полнофункциональный режим для работы с ChessKing
Особенности: 
- Высокие требования (2000 задач/день)
- Режим обучения 9:00-10:00 с временной приостановкой требований
- Универсальные фильтры и контроль времени
- Анимации и автоклик для ChessKing
```

**Режим 3: Lichess** ♞
```
Включить: #03-07, #09-10
Отключить: #01, #02, #08
Описание: Полнофункциональный режим для работы с Lichess
Особенности:
- Средние требования (500 задач/день)
- Режим обучения 9:00-10:00 с временной приостановкой требований
- Универсальные фильтры и контроль времени
- Без анимаций ChessKing (не нужны для Lichess)
```

**Настройки режима обучения** ⚙️
```
Для отключения обучения в любом режиме:
Открыть 10_training_redirect.js → установить enableTrainingMode = false
Либо полностью отключить скрипт #10 в Tampermonkey
```

## Устранение неполадок

### Скрипты не работают
1. Проверьте совпадение доменов в `@match`
2. Убедитесь, что Tampermonkey включён
3. Проверьте консоль браузера на ошибки
4. **Убедитесь, что не включены конфликтующие скрипты**

### Данные не синхронизируются
1. Проверьте, что основной трекер (01) запущен
2. Убедитесь, что скрипты используют одинаковый `courseId`
3. Проверьте права доступа к GM_getValue/GM_setValue

### Конфликты скриптов
1. **Используйте только один из рекомендованных режимов**
2. В турнирном режиме отключите скрипты 01-07
3. Не запускайте одновременно 07, 08 (конфликт блокировки)
4. **НЕ используйте одновременно 01 и 09** (конфликт трекеров)
4. Проверьте, что нет дублирующихся `@match` директив
5. Убедитесь в правильном порядке загрузки скриптов

## Журнал изменений

**v1.0** - Первоначальное разделение монолитного скрипта на модули  
**v1.3** - Добавлен турнирный режим, переведены названия на русский язык

## Поддержка

При возникновении проблем:
1. Проверьте консоль браузера (F12)
2. Убедитесь в актуальности версий скриптов
3. Проверьте настройки Tampermonkey

---

*Документация создана для модульной системы управления шахматными сайтами через Tampermonkey*